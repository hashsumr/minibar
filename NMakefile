CC      = cl
AR      = lib
CFLAGS  = /nologo /utf-8 /W4 /Zi /MD /Ipthread_compat
LDFLAGS =

PROGS   = libminibar.lib testbar1.exe testbar.exe threadbar.exe
OBJS    = minibar.obj testbar1.obj testbar.obj threadbar.obj

PTHREAD_COMPAT_OBJS = pthread_barrier.obj pthread_win32.obj

all: $(PROGS)

pthread_barrier.obj: pthread_compat/pthread_barrier.c
	$(CC) $(CFLAGS) /c /Fo$@ $**

pthread_win32.obj: pthread_compat/pthread_win32.c
	$(CC) $(CFLAGS) /c /Fo$@ $**

.c.obj:
	$(CC) $(CFLAGS) /c /Fo$@ $**

libminibar.lib: minibar.obj minibar.h
	$(AR) /nologo /OUT:$@ minibar.obj

testbar1.exe: testbar1.obj minibar.obj $(PTHREAD_COMPAT_OBJS)
	$(CC) $(CFLAGS) /Fe:$@ testbar1.obj minibar.obj $(PTHREAD_COMPAT_OBJS) $(LDFLAGS)

testbar.exe: testbar.obj minibar.obj $(PTHREAD_COMPAT_OBJS)
	$(CC) $(CFLAGS) /Fe:$@ testbar.obj minibar.obj $(PTHREAD_COMPAT_OBJS) $(LDFLAGS)

threadbar.exe: threadbar.obj minibar.obj $(PTHREAD_COMPAT_OBJS)
	$(CC) $(CFLAGS) /Fe:$@ threadbar.obj minibar.obj $(PTHREAD_COMPAT_OBJS) $(LDFLAGS)

clean:
	-del /Q *.obj *.exe *.lib *.pdb *.ilk $(PROGS)

# debugging: devenv /debugexe main.exe
